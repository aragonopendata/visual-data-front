<!-- Error -->
<div class="container" *ngIf="errorTitle">
  <div class="alert alert-info" role="alert">
      <div class="row">
          <div class="col-xs-3">
              <div class="icon-fa fa fa-exclamation-triangle fa-5x" tabindex="{{openedMenu ? -1 : 0}}" style="margin:15px;color: #5ea2ba;"></div>
              <span class="sr-only">Error</span>
          </div>
          <div class="col-xs-9">
              <h1>{{errorTitle}}</h1>
              <h2>{{errorMessage}}</h2>
              <a class="mail" href="mailto:opendata@aragon.es">
                  <h2> <div class="icon-fa fa fa-envelope" tabindex="{{openedMenu ? -1 : 0}}"></div> Contactar con el Administrador</h2>
                  <span class="sr-only">Enviar correo</span>
              </a>
          </div>
      </div>
  </div>
</div>

<!-- Loading -->
<div class="loading text-center" *ngIf="loading">
  <div class="loadingText" *ngIf="previewHistory">Cargando historia</div><br/><br/>
  <div class="loadingText" *ngIf="!previewHistory">Cargando...</div><br/><br/>
  <div class="icon-fa fa fa-circle-o-notch fa-spin fa-3x fa-fw" tabindex="{{openedMenu ? -1 : 0}}"></div><br/><br/>
  <span class="sr-only">Cargando</span> 
</div>
<div class="loading loading-overlay" *ngIf="loadingModal">
  <div class="inner">
    <div class="icon-fa fa fa-circle-o-notch fa-spin fa-3x fa-fw" tabindex="{{openedMenu ? -1 : 0}}"></div>
    <span class="sr-only">Cargando</span>
  </div>
</div>

<!-- Formulario -->

<div *ngIf="!loading && !errorTitle">

  <div class="row title">
    <h2 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Crear una nueva historia</h2>
  </div>
  
  <form [formGroup]="historyForm">
    <div class="row">
      <div class="col-md-12">
        <div class="tab-content">
          <div class="tab-pane active" id="content_tab" role="tabpanel">
            <!-- Titulo historia -->
            <div>         
                <label for="title_history">
                  <h3 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Título *</h3>
                </label>               
                <p tabindex="{{openedMenu ? -1 : 0}}">
                    Por favor, escribe una denominación de la historia. El nombre que des a la historia es importante para que otros usuarios encuentren la información.
                </p>
                
                <input tabindex="{{openedMenu ? -1 : 0}}" class="col-12 form-control" id="title_history" type="text" placeholder="Título" formControlName="title" [class.is-invalid]="invalidTitle" (keyup.enter)="saltaCampo($event, 'category')">
                <span class="sr-only">Titulo de la historia</span>
                <small *ngIf="invalidTitle" class="text-danger">Campo Obligatorio</small>
            </div>
  
            <!-- Descripcion historia -->
            <div>
              <h3 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Descripción</h3>
              <p tabindex="{{openedMenu ? -1 : 0}}">
                La descripción es la primera aproximación de un usuario a tu conjunto de datos, así que se debería comenzar contando brevemente
                qué contiene el mismo. Si el conjunto de datos contiene informaciones parciales, limitaciones o deficiencias este
                es el lugar en el que puedes mencionarlas de forma que los usuarios puedan saber el alcance de la información. En
                algunos casos los usuarios ayudan a mejorar la información, así que no desaproveches la oportunidad de acercarles
                la realidad del dato.
              </p>
              <angular-tinymce tabindex="{{openedMenu ? -1 : 0}}" id="editor" [settings]="settings" formControlName="description"></angular-tinymce>
              <span class="sr-only">Descripcion de la historia</span>
            </div>
  
            <!-- Categorias historia -->
            <!-- Categoria primaria -->
            <div>
              <h3 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Categorización</h3>
              <p tabindex="{{openedMenu ? -1 : 0}}">
                Por favor, introduce un listado de etiquetas que describan el contenido de tu conjunto de datos. Utiliza palabras comunes
                para describirlo. A poder ser utiliza palabras de las que te sugiere el formulario, ya que son categorías que ya están siendo
                utilizadas.
              </p>
              
              <div class="group">
                <label for="category">
                  <h4 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Categoría principal</h4>
                </label>
                <select tabindex="{{openedMenu ? -1 : 0}}" class="form-control select-cat1" id="category" formControlName="category" id="category"  (change)="onChangePrimaryCategory($event)">
                  <option  *ngFor="let category of categories" [ngValue]="category.id">{{category.name}}</option>
                  <!--<span class="sr-only">Categoria principal: {{category.name}}</span>-->
                </select>
              </div>
              
              <div class="group">
                <h4 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Categorías secundarias</h4>
  
                <div class="btn-group select-cat2" dropdown> 
                  <button tabindex="{{openedMenu ? -1 : 0}}" id="button-cat2" dropdownToggle type="button" class="btn btn-outline-secondary dropdown-toggle">
                    <span class="sr-only">Categoria secundaria</span>
                    Seleccione las categorias <span class="caret"></span>
                  </button>
                  <div id="dropdown-cat2" *dropdownMenu class="dropdown-menu">
                    <div class="form-check" *ngFor="let category of secondCategories" (click)="getCategoriesSelected($event, category)" (keyup)="getCategoriesSelected($event, category)" >
                      <label tabindex="{{openedMenu ? -1 : 0}}" *ngIf="!category.selectedPrincipal" class="container" for="category">
                        <span class="checkmark" id="category" [ngClass]="{'selected': category.selected}"></span>
                        {{category.name}}
                        <span class="sr-only">Categoria secundaria: {{category.name}}</span>
                      </label>
                    </div>
                  </div>
                </div>
  
                <div class="cat-selected">
                  <ng-container *ngFor="let category of secondCategories">
                    <div class="tag" *ngIf="category.selected" tabindex="{{openedMenu ? -1 : 0}}">
                      <span>{{category.name}}</span>
                      <span class="sr-only">Categoria secundaria: {{category.name}}</span>
                    </div>
                  </ng-container>
                </div>
              </div> 
              
            </div>

            <!-- Lista de contenidos -->
            <div class="contents-select" *ngIf="contents && contents.length > 0">
              <h3 class="form-section-title" tabindex="{{openedMenu ? -1 : 0}}">Contenidos</h3>
              <div *ngFor="let content of contents; let i = index">
                <!--<i aria-hidden="true" title="edit" class="fa fa-edit" (click)="editContent(content,i)"></i>-->
                <div class="icon-fa fa fa-edit" tabindex="{{openedMenu ? -1 : 0}}" title="edit" (click)="editContent(content,i)"></div>
                <span class="sr-only">Editar contenido</span>
                <div tabindex="{{openedMenu ? -1 : 0}}" title="eiminar" class="icon-fa fa fa-trash" (click)="deleteContent(content)"></div>
                <span class="sr-only">Eliminar contenido</span>
                <p tabindex="{{openedMenu ? -1 : 0}}">
                  <span>Titulo: </span>
                  {{content.title}} 
                  <span class="sr-only">Título del contenido: {{category.name}}</span>
                </p>
              </div>
            </div> 
  
            <!-- Add content -->
            <button *ngIf="!showAddContent" class="btn-add-content btn btn-outline-secondary" type="button" (click)="addNewContent()" tabindex="{{openedMenu ? -1 : 0}}">
              <span class="sr-only">Añadir contenido</span>
              <div class="icon-fa fa fa-plus"></div> Añadir contenido
              <span class="sr-only">Añadir contenido</span>
            </button>
  
            <div #newContentElement *ngIf="showAddContent">
              <div class="card card-body">
                <app-edit-content [content]="contentToEdit" [posContent]="posToEdit" (contentCreate)="newContent($event)" (closeContent)="closeNewContent()" (changeContent)="changeContent($event)"></app-edit-content>
              </div>
            </div>
  
          </div>
  
        </div>
      </div>
    </div>
    <div class="actions" *ngIf="!loadingModal">
        <button tabindex="{{openedMenu ? -1 : 0}}" *ngIf="( isAdmin ||  (!isAdmin && (historyBack.state == stateEnum.borrador || historyBack.state == stateEnum.publicada)))" class="btn btn-outline-primary" [ngClass]="historyForm.invalid ? 'disabled' : '' " (click)=getPreviewHistory()> Previsualizar</button><span class="sr-only">Previsualizar</span>
        <button tabindex="{{openedMenu ? -1 : 0}}" #btnSave *ngIf="( isAdmin ||  (!isAdmin && (historyBack.state == stateEnum.borrador)))"  id="btnSaveHistory" type="button" class="btn btn-outline-primary" [ngClass]="historyForm.invalid ? 'disabled' : '' " data-toggle="modal" (click)="getHistoryForm(btnSave, true)"> Guardar historia</button><span class="sr-only">Guardar historia</span>       
        <button tabindex="{{openedMenu ? -1 : 0}}" #btnRevision *ngIf="(!isAdmin && (historyBack.state == stateEnum.borrador))" id="btnSendRevision" type="submit" class="btn btn-primary" [ngClass]="historyForm.invalid ? 'disabled' : ''" (click)="getHistoryForm(btnRevision, true)" >Enviar a revisión</button><span class="sr-only">Enviar a revisión</span>
        <button tabindex="{{openedMenu ? -1 : 0}}" #btnPublicar *ngIf="(isAdmin &&  (historyBack.state == stateEnum.revision))" id="btnSendPublicar" type="submit" class="btn btn-primary" [ngClass]="(historyForm.invalid || (!saved && this.isModified)) ? 'disabled' : ''" (click)="getHistoryForm(btnPublicar, true)" >Publicar</button><span class="sr-only">Publicar</span>
        <button tabindex="{{openedMenu ? -1 : 0}}" #btnVersionar *ngIf="(!isAdmin && (historyBack.state == stateEnum.publicada))" id="btnSendVersionar" type="submit" class="btn btn-primary" [ngClass]="historyForm.invalid ? 'disabled' : ''" (click)="getHistoryForm(btnVersionar, true)" >Enviar a revision</button><span class="sr-only">Enviar a revision</span>
    </div>
  </form>
  
  <!-- Modal Email -->
  <!--<div class="modal fade" id="emailModalCenter" tabindex="-1" role="dialog" aria-labelledby="emailModalCenterTitle" aria-hidden="true" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="emailModalCenterTitle">Introduce tu Email:</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form [formGroup]="emailForm">
          <div class="modal-body">
            <input type="text" class="form-control" placeholder="Email" [class.is-invalid]="invalidEmail" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{1,}$" formControlName="email" (keyup.enter)="saveMailForm()">
            <small *ngIf="invalidEmail" class="text-danger">Introduzca un email válido</small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" [ngClass]="emailForm.invalid ? 'disabled' : '' " (click)="saveMailForm()">Continuar</button>
          </div>
        </form>
      </div>
    </div>
  </div>-->

  <!-- Modal Successfull History -->
  <div class="modal fade successfullModal" id="successfullModalCenter" tabindex="-1" role="dialog" aria-labelledby="successfullModalCenterTitle" aria-hidden="true"  data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content" *ngIf="!loadingModal">
        <div class="modal-header">
          <h3 tabindex="{{openedMenu ? -1 : 0}}" class="modal-title form-section-title" *ngIf="historyBack.state != stateEnum.publicada" id="successfullModalCenterTitle">¡Historia guardada correctamente!</h3>
          <h3 tabindex="{{openedMenu ? -1 : 0}}" class="modal-title form-section-title" *ngIf="historyBack.state == stateEnum.publicada" id="successfullModalCenterTitle">¡Historia publicada correctamente!</h3>
          <button  tabindex="{{openedMenu ? -1 : 0}}" type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="viewHistory()">
            <span class="sr-only">Cerrar modal historia guardada</span>
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div *ngIf=firstTime>
            <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="historyBack.state == stateEnum.borrador">Su historia {{historyModel.title}}, se ha guardado correctamente con el siguiente token. Apúntelo para poder gestionar la historia</p>
            <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="historyBack.state == stateEnum.revision">Su historia {{historyModel.title}}, se ha enviado correctamente para su revisión con el siguiente token.</p>
            <div class="tokenSite col-12">
              <span class="sr-only">EL token es:</span>
              <textarea tabindex="{{openedMenu ? -1 : 0}}" readonly #tokenGenerate id="history_token" class="tokenTextArea">{{historyModel.token}}</textarea>
              <button tabindex="{{openedMenu ? -1 : 0}}" type="button" class="btn fa fa-copy" (click)="copyToken()" ></button>
              <span class="sr-only">Copiar Token</span>
            </div>
            <div *ngIf=!haveMail>
              <div class="modal-header">
                <h4 tabindex="{{openedMenu ? -1 : 0}}" class="modal-title form-section-title" id="emailModalCenterTitle">¿Desea realizar un seguimiento de la historia?</h4>
              </div>
              <form [formGroup]="emailForm">
                <div class="modal-body">
                  <p tabindex="{{openedMenu ? -1 : 0}}"> Puede dejar su correo para ser notificado cuando se produzcan algunos cambios en el estado de su historia o si desea recibir el token en su correo electrónico</p>
                  <input tabindex="{{openedMenu ? -1 : 0}}" type="text" id="email" class="form-control" placeholder="Email" [class.is-invalid]="invalidEmail" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{1,}$" formControlName="email" (keyup.enter)="saveMailForm($event)">
                  <span class="sr-only">Introduzca el mal</span>
                  <small *ngIf="invalidEmail" class="text-danger">Introduzca un email válido</small>
                </div>
                <div class="modal-footer">
                  <button tabindex="{{openedMenu ? -1 : 0}}" type="submit" class="btn btn-primary" [ngClass]="emailForm.invalid ? 'disabled' : '' " (click)="saveMailForm($event)">Enviar</button>
                  <span class="sr-only">Enviar email</span>
                </div>
              </form> 
            </div>
          </div>
          <div *ngIf=!firstTime>
            <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="historyBack.state == stateEnum.borrador">Su historia {{historyModel.title}}, se ha guardado correctamente</p>
            <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="historyBack.state == stateEnum.revision">Su historia {{historyModel.title}}, se ha enviado correctamente</p>
            <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="historyBack.state == stateEnum.publicada">La historia {{historyModel.title}} ha sido publicada</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Error History -->
  <div class="modal fade errorModal" id="errorModalCenter" tabindex="-1" role="dialog" aria-labelledby="errorModalCenterTitle" aria-hidden="true"  data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h1 tabindex="{{openedMenu ? -1 : 0}}" *ngIf="(isAdmin || (historyBack.state != stateEnum.revision))"class="modal-title" id="errorModalCenterTitle">Se ha producido un error</h1>
          <h1 tabindex="{{openedMenu ? -1 : 0}}" *ngIf="(!isAdmin && (historyBack.state == stateEnum.revision))"class="modal-title" id="errorModalCenterTitle">Operación no permitida</h1>
          <button tabindex="{{openedMenu ? -1 : 0}}" type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span class="sr-only">Cerrar modal de error</span>
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="(isAdmin || (historyBack.state != stateEnum.revision))">Se ha producido un error al procesar la acción solicitada</p>
          <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="(!isAdmin && (historyBack.state == stateEnum.revision))"> Una vez que la historia ha sido enviada a aprobación, no se pueden hacer nuevas modificaciones</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Save Changes -->
  <!--<div class="modal fade errorModal" id="saveModalCenter" tabindex="-1" role="dialog" aria-labelledby="errorModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="errorModalCenterTitle">No ha guardado los cambios</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p >Asegurese de guardar los cambios efectuados antes de publicar la historia.</p>
        </div>
      </div>
    </div>
  </div>-->

  <!-- Question Content Previous -->
  <div class="modal fade errorModal" id="questionContPrevious" tabindex="-1" role="dialog" aria-labelledby="questionContPreviousTitle" aria-hidden="true"  data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h1 tabindex="{{openedMenu ? -1 : 0}}" class="modal-title form-section-title" id="questionContPreviousTitle">Info contenido</h1>
        </div>
        <div class="modal-body">
          <p tabindex="{{openedMenu ? -1 : 0}}">Si edita el contenido, perderá los cambios del contenido que se está editando en este momento con título . ¿Desea continuar?</p>
        </div>
        <div class="modal-footer">
          <button tabindex="{{openedMenu ? -1 : 0}}" type="button" class="btn btn-primary" (click)="confirmEditContent(false)">Cancelar</button><span class="sr-only">Cancelar, volver a editar</span>
          <button tabindex="{{openedMenu ? -1 : 0}}" type="button" class="btn btn-primary" (click)="confirmEditContent(true)">Confirmar</button><span class="sr-only">Confirmar, perder cambios</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Question History -->
  <div class="modal fade errorModal" id="questionDeleteContent" tabindex="-1" role="dialog" aria-labelledby="questionDeleteContentTitle" aria-hidden="true"  data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h1 tabindex="{{openedMenu ? -1 : 0}}" class="modal-title form-section-title" id="questionDeleteContentTitle">Borrar contenido</h1>
          <button tabindex="{{openedMenu ? -1 : 0}}" type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="closeDeleteContentModal()">
            <span class="sr-only">Cerrar modal borrar contenido</span>
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="showAddContent && !previousButton">Por favor, antes de eliminar un contenido, guarde o cierre el contenido que se está editando</p>
          <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="!showAddContent && !previousButton">¿Está seguro que quiere eliminar el contenido? Una vez eliminado, no se podrá recuperar</p>
          <p tabindex="{{openedMenu ? -1 : 0}}" *ngIf="previousButton">Si realiza esta acción, el contenido que está editando se perderá. ¿Desea continuar con la acción y perderlo o volver para guardar el mismo? </p>
        </div>
        <div class="modal-footer">
          <button tabindex="{{openedMenu ? -1 : 0}}" type="button" class="btn btn-primary" (click)="closeDeleteContentModal()">Volver</button><span class="sr-only">Volver, no borrar el contenido</span>
          <button tabindex="{{openedMenu ? -1 : 0}}" *ngIf="!showAddContent  && !previousButton" type="button" class="btn btn-primary" (click)="confirmDeleteContent()">Confirmar</button><span class="sr-only">Confirmar, borrar contenido</span>
          <button tabindex="{{openedMenu ? -1 : 0}}" *ngIf="previousButton" type="button" class="btn btn-primary" (click)="getHistoryForm(null, false)">Confirmar</button><span class="sr-only">Confirmar, borrar contenido</span>
        </div>
      </div>
    </div>
  </div>

</div>